#include <reg51.h>
#include <uart.h>
#define uchar unsigned char

code unsigned char seg7code[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xff}; 	//?????????????
code unsigned char seg7codeB[]={0x40,0x79,0x24,0x30,0x19,0x12,0x02,0x78,0x00,0x10,0xff}; 	//????????????
int count = 0;

sbit DQ=P3^6; 				//??????????????? 
unsigned char tempL=0; 		//?????
unsigned char tempH=0; 
unsigned int sdata;			//???????????
unsigned char xiaoshu1;		//?????
unsigned char xiaoshu2;		//?????
unsigned char xiaoshu;		//????
bit fg=1;        			//??????

sbit key = P3^2;

void delay(unsigned char i)
{
	for(i;i>0;i--);
}

void delay1(uchar i)
{
	uchar j,k; 
	for(j=i;j>0;j--)
		for(k=125;k>0;k--);
}

void Init_DS18B20(void) 
{
	unsigned char x=0;
	DQ=1; 					//DQ??? 
	delay(8); 				//???
	DQ=0; 					//?????? 
	delay(80); 				//??(>480us) 
	DQ=1; 					//????? 
	delay(5); 				//??(15~60us) 
	x=DQ; 					//?X?????????????,18B20????X=0,??X=1 
	delay(20); 
}

//?????
ReadOneChar(void)  			//?????????????1us??,??????????,???????
{
	unsigned char i=0; 		//?????????????60us,??????????1us?????????
	unsigned char dat=0; 
	for (i=8;i>0;i--) 		//?????8? 
	{
		DQ=1; 
		delay(1); 
		DQ=0;
		dat>>=1; 
		DQ=1; 
		if(DQ) 
		dat|=0x80; 
		delay(4);
	} 
	return(dat);
}

//?????
void WriteOneChar(unsigned char dat) 
{ 
	unsigned char i=0; 		//????????????,????????15us??????????????,
	for(i=8;i>0;i--) 		//?15~60us??????????,????????1,??0??? 
	{
		DQ=0; 				//?????????????1us?????????? 
		DQ=dat&0x01; 
		delay(5); 
		DQ=1; 
		dat>>=1;
	} 
	delay(4);
}

//????(???tempL;???tempH;)
void ReadTemperature(void) 
{ 
	Init_DS18B20(); 					//???
	WriteOneChar(0xcc); 				//?????????
	WriteOneChar(0x44); 				//??????
	delay(125); 						//????????,?? 
	Init_DS18B20(); 					//???
	WriteOneChar(0xcc); 				//????????? 
	WriteOneChar(0xbe); 				//??????(???????????????) 
	tempL=ReadOneChar(); 				//???????LSB
	tempH=ReadOneChar(); 				//???????MSB	
	if(tempH>0x7f)      				//????1?????
	{
		tempL=~tempL;					//????,????
		tempH=~tempH+1;       
		fg=0;      						//???????fg=0
	}
	sdata = tempL/16+tempH*16;      	//????
	xiaoshu1 = (tempL&0x0f)*10/16; 		//?????
	xiaoshu2 = (tempL&0x0f)*100/16%10;	//?????
	xiaoshu=xiaoshu1*10+xiaoshu2; 		//????
}

//????
void Led(unsigned int date)
{ 
	if(fg==1)
	{
		P2=0xef;     			//P1.0=0,?????
		P0=seg7code[date/10];  	//???,??,??
		delay1(5);
		P0=0xff;        		//??
		//sendmsg(date/10+'0');
		
		P2=0xdf;     			//P1.1=0,?????,???
		P0=seg7codeB[date%10];
		delay1(5);
		P0=0xff;       			//??
		//sendmsg(date%10+'0');

		//sendmsg('.');
		
		P2=0xbf;     			//P1.3=0,?????,??????
		P0=seg7code[xiaoshu1];
		delay1(5);
		P0=0xff;         		//??
		//sendmsg(xiaoshu1+'0');
		
		P2=0x7f;     			//P1.3=0,?????,??????
		P0=seg7code[xiaoshu2];
		delay1(5);
		P0=0xff;       			//??
		//sendmsg(xiaoshu2+'0');

	}
		
	if(fg==0)  					//??????????
	{
		P2=0xfe;     			//P1.0=0,?????
		P0=seg7code[11];  		//????
		delay1(5);
		P0=0xff;        		//??
		
		P2=0xfd;     			//P1.1=0,?????,???
		P0=seg7code[date/10];
		delay1(5);
		P0=0xff;       			//??
		
		P2=0xfb;     			//P1.3=0,?????,???
		P0=seg7codeB[date%10];
		delay1(5);
		P0=0xff;         		//??
		
		P2=0xf7;     			//P1.3=0,?????,??????
		P0=seg7code[xiaoshu1];
		delay1(5);
		P0=0xff;       			//??
	}
}
void send(int date)
{
	  //sendmsg('*');
	  sendmsg(date/10+'0');
	  sendmsg(date%10+'0');
	  //sendmsg('.');
	  //sendmsg(xiaoshu1+'0');
	  //sendmsg(xiaoshu2+'0');
	  //count++;
	  //sendmsg('#');
	  //sendmsg(' ');

}
/*int keyflag(int a)
{
	int cc = 20;
	if(a == 0)
	{
		while(cc--);
		if(a == 0)
		{
			return 1;
		}
		else
		{
			return 0;
		}
		while(a == 0);
	}
} */
void delay_ms(unsigned int xms)  // xms??????????
{
    unsigned int x,y;
    for(x=xms;x>0;x--)
        for(y=110;y>0;y--);
}
void main()
{
 	initcom();
	//init_time();
	while(1)
	{
		delay_ms(1000);
		ReadTemperature();
		count++;
		Led(sdata);
		//count = 0;
		if(count>=2) send(sdata);
	}
}

